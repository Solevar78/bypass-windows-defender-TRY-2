import os
import subprocess
import sys

def install_pyinstaller():
    try:
        import PyInstaller
    except ImportError:
        subprocess.check_call([sys.executable, "-m", "pip", "install", "pyinstaller"])

def create_win11_defender_disable():
    win11_code = '''import os
import subprocess
import time
import ctypes
import sys

def run_as_admin():
    try:
        if ctypes.windll.shell32.IsUserAnAdmin():
            return True
        ctypes.windll.shell32.ShellExecuteW(None, "runas", sys.executable, " ".join(sys.argv), None, 1)
        return False
    except:
        return False

if not run_as_admin():
    sys.exit()

time.sleep(1)

# Команды для отключения Защитника в Windows 11
commands = [
    # Сначала отключаем Tamper Protection
    'reg add "HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows Defender\\\\Features" /v "TamperProtection" /t REG_DWORD /d 0 /f',
    'reg add "HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows Defender\\\\Features" /v "TamperProtectionSource" /t REG_DWORD /d 0 /f',
    
    # Основные политики отключения
    'reg add "HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender" /v "DisableAntiSpyware" /t REG_DWORD /d 1 /f',
    'reg add "HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender" /v "DisableAntiVirus" /t REG_DWORD /d 1 /f',
    'reg add "HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection" /v "DisableRealtimeMonitoring" /t REG_DWORD /d 1 /f',
    'reg add "HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Real-Time Protection" /v "DisableBehaviorMonitoring" /t REG_DWORD /d 1 /f',
    
    # Дополнительные настройки для Windows 11
    'reg add "HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows Defender\\\\Security Center" /v "DisableVirusUI" /t REG_DWORD /d 1 /f',
    
    # Останавливаем службы
    'sc stop WinDefend',
    'sc config WinDefend start= disabled',
    'sc stop WdNisSvc',
    'sc config WdNisSvc start= disabled',
    'sc stop SecurityHealthService',
    'sc config SecurityHealthService start= disabled',
    
    # Обновляем политики
    'gpupdate /force'
]

for cmd in commands:
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
        time.sleep(0.5)
    except Exception as e:
        pass

# Дополнительные PowerShell команды
ps_commands = [
    "Set-MpPreference -DisableRealtimeMonitoring $true",
    "Set-MpPreference -DisableBehaviorMonitoring $true",
    "Set-MpPreference -PUAProtection disable"
]

for cmd in ps_commands:
    try:
        subprocess.run(["powershell", "-Command", cmd], capture_output=True)
        time.sleep(0.5)
    except:
        pass
'''

    with open('win11_defender_disable.py', 'w', encoding='utf-8') as f:
        f.write(win11_code)

def compile_to_exe():
    os.system('pyinstaller --onefile --noconsole --name "Win11DefenderDisable" win11_defender_disable.py')
    print("EXE создан: Win11DefenderDisable.exe")

if __name__ == "__main__":
    install_pyinstaller()
    create_win11_defender_disable()
    compile_to_exe()

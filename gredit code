from pywinauto import Application
import time

def open_gpedit_and_disable_defender():
    # Запускаем редактор локальной групповой политики
    app = Application(backend="uia").start("gpedit.msc")
    time.sleep(3)  # ждем загрузки окна

    dlg = app.window(title_re=".*Групповая политика.*")
    dlg.wait('visible', timeout=10)

    tree = dlg.child_window(control_type="Tree")

    # Путь к нужному разделу
    path = [
        "Конфигурация компьютера",
        "Административные шаблоны",
        "Компоненты Windows",
        "Антивирусная программа «Защитник Windows»"
    ]

    # Раскрываем каждую ветку
    for i in range(len(path)):
        node_path = "\" + "\".join(path[:i+1])
        item = tree.get_item(node_path)
        item.ensure_visible()
        item.expand()
        time.sleep(1)

    # Выбираем пункт "Выключить антивирусную программу „Защитник Windows“"
    setting_name = "Выключить антивирусную программу „Защитник Windows“"
    full_path = "\" + "\".join(path + [setting_name])
    try:
        param_item = tree.get_item(full_path)
        param_item.select()
    except Exception as e:
        print(f"Не удалось найти пункт настройки: {e}")
        return

    time.sleep(1)

    # Открываем окно настройки двойным кликом
    param_item.double_click_input()
    time.sleep(2)

    # Окно настроек параметра
    param_dialog = app.window(title_re=".*Выключить антивирусную программу.*")
    param_dialog.wait('visible', timeout=5)

    # Выбираем "Включено"
    try:
        enabled_radio = param_dialog.child_window(title="Включено", control_type="RadioButton")
        enabled_radio.click_input()
    except Exception as e:
        print(f"Не удалось выбрать 'Включено': {e}")
        return

    # Подтверждаем
    try:
        ok_btn = param_dialog.child_window(title="OK", control_type="Button")
        ok_btn.click_input()
    except Exception as e:
        print(f"Не удалось нажать OK: {e}")
        return

    print("Настройка успешно применена.")

if __name__ == "__main__":
    open_gpedit_and_disable_defender()
